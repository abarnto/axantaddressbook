{% extends "master.jinja" %}

{% block master_title %}
Lista Contatti
{% endblock %}


{% block contents %}
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {% if contacts %}
      <ul class="list-group">
        {% for contact in contacts %}
          <li class="list-group-item d-flex justify-content-between" data-id="{{contact.id}}">
            <span>{{ contact.name }} {{ contact.surname }}</span>
            <span>{{ contact.phone }}</span>
            <button type="button" onclick="deleteContact({{contact.id | safe }})" class="btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i></button>
          </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="alert alert-info" role="alert">
        Non ci sono contatti nella rubrica.
      </div>
      {% endif %}
    </div>
  </div>
  <div class="row">
    <div class="col-md-8 offset-md-2 d-flex justify-content-between">
    {% if contacts %}
      <button type="button" class="btn btn-primary">Esporta in JSON</button>
    {% endif %}
      <a href="/contacts/new" class="btn btn-primary">Nuovo Contatto <i class="fa fa-plus" aria-hidden="true"></i></a>
    </div>
  </div>

  <script>
    async function deleteContact(contactId) {
      const deletionConfirmed = confirm('Sei sicuro di voler cancellare questo contatto dalla rubrica?')
      if (!deletionConfirmed) return
      try {
        const response = await fetch(`http://localhost:8080/contacts/delete?id=${contactId}`, { method: 'DELETE' })
        if ((await response.json()).success) {
          const disposableListItem = document.querySelector(`li[data-id="${contactId}"]`)
          const list = disposableListItem.parentNode
          list.removeChild(disposableListItem)
          if (list.querySelectorAll('li').length === 0) {
            window.location.href = '/contacts'
          }
        }
      } catch(err) {
        console.log('An error happened while trying to delete record: ' + err)
      }
    }
  </script>
{% endblock %}
